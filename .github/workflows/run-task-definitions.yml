# This workflow will be run manually by QA after the deploy-extension-to-marketplace.yml workflow is run and AWS Marketplace listing is approved.

name: Run ECS task definitions for test_image after AWS Marketplace approval

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Liquibase Pro Docker test image_tag (e.g., 'test_image' :this will be restricted if all jobs pass)."
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  run-core-tasks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - family: version-command
            container_name: Liquibase-Secure
          - family: update-command-dynamodb
            container_name: Liquibase-Secure
    env:
      AWS_REGION: us-east-1
      CLUSTER_NAME: aws-mp-test-cluster
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_MP_GITHUB_OIDC_ROLE_ARN_AWS_LICENSE_SERVICE }}
          aws-region: us-east-1
          role-session-name: AWSMarketplaceApprovalSession

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build IMAGE_URI from tag
        id: resolve_image
        shell: bash
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"
          IMAGE_URI="${{ env.AWS_MP_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Build registerable task definition
        env:
          FAMILY: ${{ matrix.family }}
          CONTAINER_NAME: ${{ matrix.container_name }}
        run: |
          # Use task definition template from repository
          cp .github/task-definitions/$FAMILY.json task-def.json
          # Replace placeholder image URI with actual image
          jq --arg IMG "${{ steps.resolve_image.outputs.image_uri }}" --arg NAME "$CONTAINER_NAME" '
            .containerDefinitions |= (map(if .name == $NAME then .image = $IMG else . end))
          ' task-def.json > _tmp.json && mv _tmp.json task-def.json
          # Debug: Show the updated image URI
          echo "Updated task definition with image:"
          jq '.containerDefinitions[0].image' task-def.json

      - name: Register new task definition
        id: register
        run: |
          aws ecs register-task-definition --cli-input-json file://task-def.json > reg.json
          TASK_DEF_ARN=$(jq -r '.taskDefinition.taskDefinitionArn' reg.json)
          echo "task_def_arn=$TASK_DEF_ARN" >> "$GITHUB_OUTPUT"

      - name: Run task
        id: run_task
        run: |
          aws ecs run-task \
            --cluster "$CLUSTER_NAME" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ env.ECS_SUBNETS }}],assignPublicIp=ENABLED}" \
            --task-definition "${{ steps.register.outputs.task_def_arn }}" \
            --count 1 > run.json
          TASK_ARN=$(jq -r '.tasks[0].taskArn' run.json)
          echo "task_arn=$TASK_ARN" >> "$GITHUB_OUTPUT"

      - name: Wait and check exit code
        run: |
          aws ecs wait tasks-stopped --cluster "$CLUSTER_NAME" --tasks "${{ steps.run_task.outputs.task_arn }}"
          aws ecs describe-tasks --cluster "$CLUSTER_NAME" --tasks "${{ steps.run_task.outputs.task_arn }}" > desc.json
          EXIT_CODE=$(jq -r '.tasks[0].containers[0].exitCode' desc.json)
          echo "Exit code: $EXIT_CODE"
          test "${EXIT_CODE}" = "0"

  cleanup-dynamodb-test-tables:
    runs-on: ubuntu-latest
    needs: run-core-tasks
      # Cleanup DynamoDB test tables after successful test completion
      # Uses custom script instead of Liquibase dropall to protect tracking table
    if: ${{ needs.run-core-tasks.result == 'success' && inputs.image_tag != '' }}
    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_MP_GITHUB_OIDC_ROLE_ARN_AWS_LICENSE_SERVICE }}
          aws-region: us-east-1
          role-session-name: AWSMarketplaceApprovalSession

      - name: Cleanup DynamoDB test tables
        run: |
          chmod +x ./.github/scripts/cleanup-dynamodb-test-tables.sh
          ./.github/scripts/cleanup-dynamodb-test-tables.sh

  restrict-marketplace-listing:
    runs-on: ubuntu-latest
    needs: cleanup-dynamodb-test-tables
    if: ${{ needs.cleanup-dynamodb-test-tables.result == 'success' }}
    env:
      AWS_REGION: us-east-1
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_MP_GITHUB_OIDC_ROLE_ARN_AWS_LICENSE_SERVICE }}
          aws-region: us-east-1

      - name: Restrict AWS Marketplace listing
        env:
          PRODUCT_ID: ${{ env.PRODUCT_ID }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          chmod +x ./.github/utils/restrict-aws-mp-listing.sh
          ./.github/utils/restrict-aws-mp-listing.sh

      # ============================================================================
      # Mark test as completed in DynamoDB to enable automated production release
      # ============================================================================
      # Purpose:
      #   - Signals that ECS tests passed and test image restriction was initiated
      #   - Enables the next phase of automation: production release
      #
      # What happens next:
      #   1. Test image restriction completes (~15 min)
      #   2. Lambda polls and finds TestStatus=completed in DynamoDB
      #   3. Lambda verifies restriction change set has Status=SUCCEEDED
      #   4. Lambda triggers deploy-extension-to-marketplace.yml (dry_run=false)
      #   5. Production version submitted to AWS Marketplace
      #
      # Why needed:
      #   - AWS Marketplace doesn't allow simultaneous change sets
      #   - Must wait for restriction to complete before submitting production
      #   - This DynamoDB flag enables Lambda to detect when ready to proceed
      # ============================================================================
      - name: Mark TaskDefinitions as completed in DynamoDB
        if: success() && startsWith(inputs.image_tag, 'test-')
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |

          # Find the change set ID for this image tag
          CHANGE_SETS=$(aws dynamodb scan \
            --table-name liquibase-secure-marketplace-changesets \
            --filter-expression "ImageTag = :tag" \
            --expression-attribute-values '{":tag":{"S":"'"$IMAGE_TAG"'"}}' \
            --region us-east-1)

          CHANGESET_ID=$(echo "$CHANGE_SETS" | jq -r '.Items[0].ChangeSetId.S // empty')

          if [ -n "$CHANGESET_ID" ]; then
            echo "Found change set: $CHANGESET_ID for image tag: $IMAGE_TAG"

            # Update the item to mark TaskDefinition as completed
            aws dynamodb update-item \
              --table-name liquibase-secure-marketplace-changesets \
              --key '{"ChangeSetId":{"S":"'"$CHANGESET_ID"'"}}' \
              --update-expression "SET TestStatus = :status, TestCompletedAt = :timestamp" \
              --expression-attribute-values '{":status":{"S":"completed"},":timestamp":{"S":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}}' \
              --region us-east-1

            echo "✅ Marked change set $CHANGESET_ID as TaskDefinition completed"
            echo "Lambda will detect this and trigger production release after restriction is confirmed"
          else
            echo "⚠️  Warning: Could not find change set for image tag: $IMAGE_TAG"
            echo "Production release will need to be triggered manually"
          fi
